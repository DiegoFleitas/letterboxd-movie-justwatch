<!DOCTYPE html>
<html>
<head>
  <title>Test Letterboxd Poster URLs</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #14181d; color: #fff; }
    .test { margin: 20px 0; padding: 15px; background: #2c3440; border-radius: 5px; }
    img { max-width: 230px; margin: 10px; border: 2px solid #456; }
    .url { word-break: break-all; font-size: 12px; color: #9ab; margin: 5px 0; }
    .code { background: #1a1f29; padding: 8px; border-radius: 3px; font-family: monospace; font-size: 11px; margin: 5px 0; }
    .success { color: #5cb85c; font-weight: bold; }
    .error { color: #d9534f; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Testing Letterboxd CDN Poster URLs</h1>
  <p>‚úÖ Browsers CAN load these CDN URLs directly (even though server gets 403)</p>
  <p>üîß URL Construction: <code>https://a.ltrbxd.com/resized/film-poster/{ID_SEGMENTS}/{ID}-{SLUG}-0-230-0-345-crop.jpg?v={KEY}</code></p>

  <div id="tests"></div>

  <script>
    // Test cases with known working URLs
    const testCases = [
      {
        name: "The Little Drummer Girl (2018)",
        filmId: "484585",
        slug: "the-little-drummer-girl",  // No year suffix in poster filename
        key: "b91d97029d",  // Updated to working key
        useProxy: false
      },
      {
        name: "You'll Never Find Me",
        filmId: "1007317",
        slug: "you-ll-never-find-me",  // From /film/you-ll-never-find-me/ (note the -ll-)
        key: "71da5e9df6",  // Updated to match working URL
        useProxy: false
      },
      {
        name: "Her Private Hell",
        filmId: "361648",
        slug: "her-private-hell-1",  // From /film/her-private-hell-1/
        key: "57d4bdf1",
        useProxy: false
      },
      {
        name: "Nikita (1990)",
        filmId: "47271",
        slug: "la-femme-nikita",  // From /film/la-femme-nikita/
        key: "f7d1131cfb",
        useProxy: false
      },
      // Proxy tests
      {
        name: "The Little Drummer Girl (2018) [via Proxy]",
        filmId: "484585",
        slug: "the-little-drummer-girl",
        key: "b91d97029d",
        useProxy: true
      },
      {
        name: "You'll Never Find Me [via Proxy]",
        filmId: "1007317",
        slug: "you-ll-never-find-me",
        key: "71da5e9df6",
        useProxy: true
      }
    ];

    // Construct poster URL (matches server-side logic)
    function constructPosterUrl(filmId, slug, cacheBustingKey, useProxy = false) {
      const idSegments = filmId.split('').join('/');
      const cdnUrl = `https://a.ltrbxd.com/resized/film-poster/${idSegments}/${filmId}-${slug}-0-230-0-345-crop.jpg?v=${cacheBustingKey}`;
      return useProxy ? `https://stark-woodland-93683.fly.dev/${cdnUrl}` : cdnUrl;
    }

    // Render tests
    const container = document.getElementById('tests');
    testCases.forEach((test, index) => {
      const url = constructPosterUrl(test.filmId, test.slug, test.key, test.useProxy);
      
      const testDiv = document.createElement('div');
      testDiv.className = 'test';
      testDiv.innerHTML = `
        <h3>Test ${index + 1}: ${test.name}</h3>
        <div class="code">ID: ${test.filmId}, Slug: ${test.slug}, Key: ${test.key}${test.useProxy ? ' <strong style="color: #f90;">üîÑ PROXIED</strong>' : ''}</div>
        <div class="code">${url}</div>
        <img src="${url}" alt="${test.name}" data-test="${index}">
        <div class="status" id="status-${index}">‚è≥ Loading...</div>
      `;
      container.appendChild(testDiv);
    });

    // Track load status
    let loaded = 0;
    let failed = 0;
    
    document.querySelectorAll('img').forEach(img => {
      img.onerror = function() {
        failed++;
        console.error('Failed to load:', this.src);
        this.style.border = '2px solid #d9534f';
        const testIndex = this.getAttribute('data-test');
        const status = document.getElementById(`status-${testIndex}`);
        status.className = 'status error';
        status.textContent = '‚ùå Failed to load';
        updateSummary();
      };
      
      img.onload = function() {
        loaded++;
        console.log('Successfully loaded:', this.src);
        this.style.border = '2px solid #5cb85c';
        const testIndex = this.getAttribute('data-test');
        const status = document.getElementById(`status-${testIndex}`);
        status.className = 'status success';
        status.textContent = '‚úÖ Loaded successfully';
        updateSummary();
      };
    });

    function updateSummary() {
      const total = testCases.length;
      if (loaded + failed === total) {
        const summary = document.createElement('div');
        summary.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #2c3440; padding: 15px; border-radius: 5px; border: 2px solid ' + (failed > 0 ? '#d9534f' : '#5cb85c');
        summary.innerHTML = `
          <strong>üìä Results:</strong><br>
          ‚úÖ Loaded: ${loaded}/${total}<br>
          ‚ùå Failed: ${failed}/${total}
        `;
        document.body.appendChild(summary);
      }
    }
  </script>
</body>
</html>
